services:
  database:
    image: postgres:16-alpine
    restart: always
    ports:
      - "5432:5432"
    environment:
      POSTGRES_PASSWORD: admin
      POSTGRES_USER: admin
      POSTGRES_DB: jobFinderApp
    networks:
      - job-finder-app
    volumes:
      - db-volume:/var/lib/postgresql/data

  db-update:
    container_name: db-update
    image: postgres:16-alpine
    profiles:
      - init
    depends_on:
      - database
      - spring-boot-service
    volumes:
      - ./data.sql:/data.sql:ro
      - ./scripts/wait-for-it.sh:/wait-for-it.sh
    entrypoint: >
      /bin/sh -c "chmod +x /wait-for-it.sh && /wait-for-it.sh spring-boot-service:8080 --timeout=60 && psql -h database -U admin -d jobFinderApp -f /data.sql"
    environment:
      PGPASSWORD: admin
    networks:
      - job-finder-app

  spring-boot-service:
    build:
      context: ./spring-boot-service
      dockerfile: Dockerfile
    restart: always
    ports:
      - "8080:8080"
    depends_on:
      - database
      - redis
    environment:
      JWT_SECRET_FILE: /run/secrets/spring-boot-jwt-secret
      REFRESH_TOKEN_SECRET_FILE: /run/secrets/spring-boot-refresh-token-secret
      RESET_TOKEN_SECRET_FILE: /run/secrets/spring-boot-reset-token-secret
      REDIS_HOST: redis
      REDIS_PORT: 6379
      APP_SECURITY_PROFILE: prod
    secrets:
      - spring-boot-jwt-secret
      - spring-boot-refresh-token-secret
      - spring-boot-reset-token-secret
    networks:
      - job-finder-app
    develop:
      watch:
        - action: sync+restart
          path: ./spring-boot-service
          target: /opt
    healthcheck:
      test: ["CMD", "curl", "http://localhost:8080/health-check"]
      interval: 10s
      timeout: 5s
      retries: 100

  redis:
    image: redis:7-alpine
    container_name: redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - job-finder-app

  website:
    container_name: website
    build:
      context: ./website
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    depends_on:
      spring-boot-service:
        condition: service_healthy
    networks:
      - job-finder-app
    healthcheck:
      test: ["CMD", "curl", "http://localhost:3000/"]
      interval: 10s
      timeout: 5s
      retries: 5

  nginx:
    image: nginx:1.29.1-bookworm-perl
    container_name: nginx
    ports:
      - "443:443"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
      - ./certs:/etc/certs
    networks:
      - job-finder-app
    depends_on:
      spring-boot-service:
        condition: service_healthy
      website:
        condition: service_healthy

networks:
  job-finder-app:
    name: job-finder-app

secrets:
  spring-boot-jwt-secret:
    file: ./secrets/spring-boot-jwt
  spring-boot-refresh-token-secret:
    file: ./secrets/spring-boot-refresh-token
  spring-boot-reset-token-secret:
    file: ./secrets/spring-boot-reset-token

volumes:
  db-volume:
  redis_data: